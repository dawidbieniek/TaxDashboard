@page "/list"

@using BlazorTable
@using TaxDashboard.Util

@implements IDisposable

@inject ClientsService ClientsService
@inject IJSRuntime JS
@inject NavigationManager Navigation

<div class="client-table container-fluid flex-row pt-3">
    <Table TableItem="Client" Items="@_allClients" PageSize="15" TableClass="table table-striped table-hover table-bordered table-sm small w-100 rounded" TableRowClass="@((c) => c.Suspended ? "suspended" : "")">
        <Column TableItem="Client" Title="Id" Field="@(x => x.Id)" Sortable="true" Filterable="true" DefaultSortColumn="true" Width="10%" />
        <Column TableItem="Client" Title="Imię" Field="@(x => x.FullName)" Sortable="true" Filterable="true" Width="10%" >
            <Template>
                <span>@context.FullName</span>
                @if(!string.IsNullOrEmpty(context.Notes))
                {
                    <i class="bi-card-text ms-1" data-bs-toggle="tooltip" data-bs-title="@context.Notes"/>
                }
            </Template>
        </Column>
        <Column TableItem="Client" Title="NIP" Field="@(x => x.NIP)" Sortable="true" Filterable="true" Width="10%" />
        <Column TableItem="Client" Title="Email" Field="@(x => x.Email)" Sortable="true" Filterable="true" Width="10%">
            <Template>
                <a href="mailto:@(context.Email)">@context.Email</a>
            </Template>
        </Column>
        <Column TableItem="Client" Title="Telefon" Field="@(x => x.PhoneNumber)" Sortable="true" Filterable="true" Width="10%" />
        <Column TableItem="Client" Title="Zawieszony" Field="@(x => x.Suspended)" Sortable="true" Filterable="true" Width="10%">
            <Template>
                <InputCheckbox class="form-check-input m-1" style="transform:scale(1.5);" @bind-Value="@context.Suspended" @bind-Value:after="@(() => ClientsService.UpdateAsync(context))" />
            </Template>
        </Column>
        <Column TableItem="Client" Title="Bank" Field="@(x => x.Bank.Name)" Sortable="true" Filterable="true" />
        <Column TableItem="Client" Title="Data założenia" Field="@(x => x.JoinDateTime)" Format="yyyy-MM-dd" Sortable="true" Filterable="true" Width="10%" />
        <Column TableItem="Client" Title="Kasa fiskalna" Field="@(x => x.UseCashRegister)" Sortable="true" Filterable="true" Width="10%">
            <Template>
                <input class="form-check-input m-1" style="transform:scale(1.5);" type="checkbox" disabled checked="@context.UseCashRegister" />
            </Template>
        </Column>
        <Column TableItem="Client" Title="Umowa o pracę" Field="@(x => x.EmploymentContract)" Sortable="true" Filterable="true" Width="10%">
            <Template>
                <input class="form-check-input m-1" style="transform:scale(1.5);" type="checkbox" disabled checked="@context.EmploymentContract" />
            </Template>
        </Column>
        <Column TableItem="Client" Title="VAT" Field="@(x => x.VAT)" Sortable="true" Filterable="true" Width="10%">
            <Template>
                <input class="form-check-input m-1" style="transform:scale(1.5);" type="checkbox" disabled checked="@context.VAT" />
            </Template>
        </Column>
        <Column TableItem="Client" Title="Metoda kasowa" Field="@(x => x.CashMethod)" Sortable="true" Filterable="true" Width="10%">
            <Template>
                <input class="form-check-input m-1" style="transform:scale(1.5);" type="checkbox" disabled checked="@context.CashMethod" />
            </Template>
        </Column>
        <Column TableItem="Client" Title="Abonament" Field="@(x => x.Subscription)" Sortable="true" Filterable="true" Width="10%" />
        <Column TableItem="Client" Title="Koszt abonamentu" Field="@(x => x.SubscriptionPrice)" Format="C2" Sortable="true" Filterable="true" Width="10%" />
        <Column TableItem="Client" Title="Kwota autoryzacyjna" Field="@(x => x.AuthorizationPrice)" Format="C2" Sortable="true" Filterable="true" Width="10%" />
        <Column TableItem="Client" Title="Podatek" Field="@(x => x.TaxType)" Sortable="true" Filterable="true" Width="10%">
            <Template>@(context.TaxType.GetDescriptor())</Template>
        </Column>
        <Column TableItem="Client" Title="Ulga" Field="@(x => x.ReductionType)" Sortable="true" Filterable="true" Width="10%">
            <Template>@(context.ReductionType.GetDescriptor())</Template>
        </Column>
        <Column TableItem="Client" Title="Rozliczanie PIT" Field="@(x => x.PITPaymentType)" Sortable="true" Filterable="true" Width="10%">
            <Template>@(context.PITPaymentType.GetDescriptor())</Template>
        </Column>
        <Column TableItem="Client" Title="Opłacanie VAT" Field="@(x => x.VATPaymentType)" Sortable="true" Filterable="true" Width="10%">
            <Template>@(context.VATPaymentType.GetDescriptor())</Template>
        </Column>
        <Column TableItem="Client" Title="" Width="5%">
            <Template><button class="btn btn-danger p-0" style="height:22px;width:22px;" @onclick="@(async () => await ShowDeleteModalAsync(context))"><div class="bi-trash3" style="margin-top:-1px;" /></button></Template>
        </Column>
        <Pager ShowPageNumber="true" ShowTotalCount="true" />
    </Table>
</div>
<!-- Modal -->
<div class="modal" id="deletingClientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Potwierdź usunięcie</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Czy na pewno chcesz usunąć <i class="text-danger">@(_deletedModalClient?.FullName ?? "(brak imienia)")</i>?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
                <button type="button" class="btn btn-danger" @onclick="@DeleteModalClientAsync">Usuń</button>
            </div>
        </div>
    </div>
</div>

@code
{
    private List<Client> _allClients = [];
    private Client? _deletedModalClient;

    private IDisposable? _navigationLockRegistration;

    protected override async Task OnInitializedAsync()
    {
        _allClients = [.. await ClientsService.GetAllWithDetailsAsync()];
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _navigationLockRegistration = Navigation.RegisterLocationChangingHandler(OnLocationChanging);

            await JS.InvokeVoidAsync("enableTooltips");
            await JS.InvokeVoidAsync("addModalHiddenListener", DotNetObjectReference.Create(this), "OnModalHidden", "deletingClientModal");
        }
    }

    private async Task ShowDeleteModalAsync(Client client)
    {
        _deletedModalClient = client;
        await JS.InvokeVoidAsync("showModal", "deletingClientModal");
    }

    private async Task DeleteModalClientAsync()
    {
        if (_deletedModalClient is not null)
        {
            await ClientsService.DeleteAsync(_deletedModalClient.Id);
            _allClients.Remove(_deletedModalClient);
        }

        await JS.InvokeVoidAsync("hideModal", "deletingClientModal");
    }

    [JSInvokable]
    public void OnModalHidden() => _deletedModalClient = null;

    private ValueTask OnLocationChanging(LocationChangingContext context)
    {
        if (_deletedModalClient is not null)
            context.PreventNavigation();

        return ValueTask.CompletedTask;
    }

    public void Dispose() => _navigationLockRegistration?.Dispose();
}